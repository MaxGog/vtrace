<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="vtrace.Views.VpnConfigPage"
             xmlns:lvc="clr-namespace:LiveChartsCore.SkiaSharpView.Maui;assembly=LiveChartsCore.SkiaSharpView.Maui"
             xmlns:controls="clr-namespace:vtrace.Controls"
             Title="VPN Configuration"
             Background="{AppThemeBinding Light={StaticResource LightBackground}, Dark={StaticResource DarkBackground}}">

    <ScrollView>
       <VerticalStackLayout Spacing="16" Padding="20">
              <ActivityIndicator IsRunning="{Binding IsBusy}" 
                             IsVisible="{Binding IsBusy}"
                             Color="{AppThemeBinding Light={StaticResource PrimaryLight}, Dark={StaticResource PrimaryDark}}"/>

              <controls:FluentCard IsVisible="{Binding IsConnected}" 
                                CornerRadius="8"
                                Padding="16">
                <Grid ColumnDefinitions="*,*" 
                      RowDefinitions="Auto,Auto" 
                      RowSpacing="8">
                    <Label Grid.Column="0" Grid.Row="0" 
                           Text="Status:" 
                           FontSize="Medium"
                           TextColor="{AppThemeBinding Light={StaticResource Gray700}, Dark={StaticResource Gray200}}"/>
                    <Label Grid.Column="1" Grid.Row="0" 
                           Text="Connected" 
                           FontSize="Medium"
                           TextColor="{StaticResource Success}"/>
                    
                    <Label Grid.Column="0" Grid.Row="1" 
                           Text="Speed:" 
                           FontSize="Medium"
                           TextColor="{AppThemeBinding Light={StaticResource Gray700}, Dark={StaticResource Gray200}}"/>
                    <Label Grid.Column="1" Grid.Row="1" 
                           Text="{Binding ConnectionSpeed}" 
                           FontSize="Medium"/>
                </Grid>
              </controls:FluentCard>

              <controls:FluentCard IsVisible="{Binding IsConnected}" 
                                HeightRequest="180"
                                CornerRadius="8">
                <lvc:CartesianChart
                    Series="{Binding SpeedSeries}"
                    XAxes="{Binding XAxes}"
                    YAxes="{Binding YAxes}"
                    LegendPosition="Hidden"/>
              </controls:FluentCard>

              <controls:FluentCard IsVisible="{Binding ActiveConnection, Converter={StaticResource NullToBoolConverter}}" 
                            CornerRadius="8"
                            Padding="16">
              <Grid ColumnDefinitions="*,*" 
                     RowDefinitions="Auto,Auto,Auto" 
                     RowSpacing="8">
                     <Label Grid.Column="0" Grid.Row="0" 
                            Text="Status:" 
                            FontSize="Medium"
                            TextColor="{AppThemeBinding Light={StaticResource Gray700}, Dark={StaticResource Gray200}}"/>
                     <Label Grid.Column="1" Grid.Row="0" 
                            Text="Connected" 
                            FontSize="Medium"
                            TextColor="{StaticResource Success}"/>
                     
                     <Label Grid.Column="0" Grid.Row="1" 
                            Text="Server:" 
                            FontSize="Medium"
                            TextColor="{AppThemeBinding Light={StaticResource Gray700}, Dark={StaticResource Gray200}}"/>
                     <Label Grid.Column="1" Grid.Row="1" 
                            Text="{Binding ActiveConnection.Remark}" 
                            FontSize="Medium"/>
                     
                     <Label Grid.Column="0" Grid.Row="2" 
                            Text="Speed:" 
                            FontSize="Medium"
                            TextColor="{AppThemeBinding Light={StaticResource Gray700}, Dark={StaticResource Gray200}}"/>
                     <Label Grid.Column="1" Grid.Row="2" 
                            Text="{Binding ConnectionSpeed}" 
                            FontSize="Medium"/>
              </Grid>
              </controls:FluentCard>

              <controls:FluentCard CornerRadius="8">
                     <VerticalStackLayout Spacing="12">
                            <Label Text="Add New Configuration" 
                                   FontSize="18"
                                   FontAttributes="Bold"
                                   TextColor="{AppThemeBinding Light={StaticResource Gray900}, Dark={StaticResource White}}"/>
                    
                            <Entry Placeholder="Enter VLESS URL" 
                                   Text="{Binding NewConfigUrl}"
                                   PlaceholderColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}"
                                   BackgroundColor="Transparent"
                                   TextColor="{AppThemeBinding Light={StaticResource Gray900}, Dark={StaticResource White}}"/>
                    
                            <Button Text="Add Configuration" 
                                   Command="{Binding AddConfigCommand}"
                                   CornerRadius="4"
                                   HeightRequest="44"
                                   FontSize="14"
                                   IsEnabled="{Binding IsBusy, Converter={StaticResource InverseBooleanConverter}}"
                                   BackgroundColor="{AppThemeBinding Light={StaticResource PrimaryLight}, Dark={StaticResource PrimaryDark}}"
                                   TextColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource Gray100}}"/>
                     </VerticalStackLayout>
              </controls:FluentCard>

              <Label Text="{Binding StatusMessage}" 
                   FontSize="14"
                   Margin="0,-8,0,0"
                   TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray300}}"/>
            
              <Label Text="Saved Configurations" 
                   FontSize="18"
                   FontAttributes="Bold"
                   Margin="0,8"
                   TextColor="{AppThemeBinding Light={StaticResource Gray900}, Dark={StaticResource White}}"/>
            
              <RefreshView IsRefreshing="{Binding IsBusy}"
                         Command="{Binding LoadConfigsCommand}">
                <CollectionView ItemsSource="{Binding Configs}"
                               SelectionMode="None">
                    <CollectionView.ItemTemplate>
                        <DataTemplate>
                            <controls:FluentCard CornerRadius="8" 
                                                Margin="0,0,0,12"
                                                Padding="16">
                                <Grid ColumnDefinitions="*,Auto,Auto" 
                                      RowDefinitions="Auto,Auto,Auto"
                                      RowSpacing="6">
                                    
                                    <Label Grid.Column="0" Grid.Row="0"
                                           Text="{Binding Remark}" 
                                           FontSize="16"
                                           FontAttributes="Bold"
                                           TextColor="{AppThemeBinding Light={StaticResource Gray900}, Dark={StaticResource White}}"/>
                                    
                                    <Label Grid.Column="0" Grid.Row="1"
                                           Text="{Binding Address}"
                                           FontSize="14"
                                           TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray300}}"/>
                                    
                                    <Label Grid.Column="0" Grid.Row="2"
                                           Text="{Binding LastError}"
                                           FontSize="14"
                                           TextColor="{StaticResource Error}"
                                           IsVisible="{Binding LastError, Converter={StaticResource NullToBoolConverter}}"/>
                                    
                                    <Button Grid.Column="1" Grid.Row="0" Grid.RowSpan="3"
                                            Text="{Binding IsConnected, Converter={StaticResource BoolToConnectTextConverter}}"
                                            CornerRadius="4"
                                            HeightRequest="36"
                                            FontSize="14"
                                            WidthRequest="100"
                                            Margin="8,0"
                                            BackgroundColor="{Binding IsConnected, Converter={StaticResource BoolToColorConverter}}"
                                            TextColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource Gray100}}"
                                            Command="{Binding BindingContext.ConnectCommand, Source={RelativeSource AncestorType={x:Type ContentPage}}}"
                                            CommandParameter="{Binding Id}"/>
                                    
                                    <Button Grid.Column="2" Grid.Row="0" Grid.RowSpan="3"
                                            Text="Delete"
                                            CornerRadius="4"
                                            HeightRequest="36"
                                            FontSize="14"
                                            WidthRequest="80"
                                            Margin="8,0"
                                            BackgroundColor="{StaticResource ErrorLight}"
                                            TextColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource Gray100}}"
                                            Command="{Binding BindingContext.DeleteConfigCommand, Source={RelativeSource AncestorType={x:Type ContentPage}}}"
                                            CommandParameter="{Binding Id}"/>
                                </Grid>
                            </controls:FluentCard>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>
            </RefreshView>

            <Button Text="Disconnect" 
                    Command="{Binding DisconnectCommand}"
                    CornerRadius="4"
                    HeightRequest="44"
                    FontSize="14"
                    HorizontalOptions="Fill"
                    Margin="0,16"
                    IsVisible="{Binding Configs, Converter={StaticResource AnyItemConnectedConverter}}"
                    BackgroundColor="{StaticResource Error}"
                    TextColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource Gray100}}"/>
            
        </VerticalStackLayout>
    </ScrollView>
</ContentPage>