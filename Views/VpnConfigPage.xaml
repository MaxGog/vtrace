<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="vtrace.Views.VpnConfigPage"
             xmlns:lvc="clr-namespace:LiveChartsCore.SkiaSharpView.Maui;assembly=LiveChartsCore.SkiaSharpView.Maui">

    <ScrollView>
        <VerticalStackLayout Spacing="20" Padding="20">
            
            <ActivityIndicator IsRunning="{Binding IsBusy}" IsVisible="{Binding IsBusy}"/>

            <Frame IsVisible="{Binding IsConnected}">
                <Grid ColumnDefinitions="*,*" RowDefinitions="Auto,Auto" RowSpacing="10">
                    <Label Grid.Column="0" Grid.Row="0" Text="Status:" FontAttributes="Bold"/>
                    <Label Grid.Column="1" Grid.Row="0" Text="Connected" TextColor="Green"/>
                    
                    <Label Grid.Column="0" Grid.Row="1" Text="Speed:" FontAttributes="Bold"/>
                    <Label Grid.Column="1" Grid.Row="1" Text="{Binding ConnectionSpeed}"/>
                </Grid>
            </Frame>

            <Frame IsVisible="{Binding IsConnected}" HeightRequest="150">
                <lvc:CartesianChart
                    Series="{Binding SpeedSeries}"
                    XAxes="{Binding XAxes}"
                    YAxes="{Binding YAxes}"
                    LegendPosition="Hidden"/>
            </Frame>

            <Frame>
                <VerticalStackLayout Spacing="10">
                    <Label Text="Add New Configuration" FontSize="Medium" FontAttributes="Bold"/>
                    <Entry Placeholder="Enter VLESS URL" Text="{Binding NewConfigUrl}"/>
                    <Button Text="Add Configuration" 
                            Command="{Binding AddConfigCommand}"
                            IsEnabled="{Binding IsBusy, Converter={StaticResource InverseBooleanConverter}}"/>
                </VerticalStackLayout>
            </Frame>

            <Label Text="{Binding StatusMessage}" 
                   FontSize="Small"
                   TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray300}}"/>
            
            <Label Text="Saved Configurations" FontSize="Medium" FontAttributes="Bold"/>
            
            <RefreshView IsRefreshing="{Binding IsBusy}"
                         Command="{Binding LoadConfigsCommand}">
                <CollectionView ItemsSource="{Binding Configs}">
                    <CollectionView.ItemTemplate>
                        <DataTemplate>
                            <Frame>
                                <Grid ColumnDefinitions="*,Auto,Auto" 
                                    RowDefinitions="Auto,Auto,Auto"
                                    RowSpacing="5">
                                    
                                    <Label Grid.Column="0" Grid.Row="0"
                                        Text="{Binding Remark}" 
                                        FontAttributes="Bold"/>
                                    
                                    <Label Grid.Column="0" Grid.Row="1"
                                        Text="{Binding Address}"
                                        FontSize="Small"/>
                                    
                                    <Label Grid.Column="0" Grid.Row="2"
                                        Text="{Binding LastError}"
                                        FontSize="Small"
                                        TextColor="{StaticResource Error}"
                                        IsVisible="{Binding LastError, Converter={StaticResource NullToBoolConverter}}"/>
                                    
                                    <Button Grid.Column="1" Grid.Row="0" Grid.RowSpan="3"
                                            Text="{Binding IsConnected, Converter={StaticResource BoolToConnectTextConverter}}"
                                            BackgroundColor="{Binding IsConnected, Converter={StaticResource BoolToColorConverter}}"
                                            Command="{Binding BindingContext.ConnectCommand, Source={RelativeSource AncestorType={x:Type ContentPage}}}"
                                            CommandParameter="{Binding Id}"
                                            WidthRequest="100"
                                            Margin="5,0"/>
                                    
                                    <Button Grid.Column="2" Grid.Row="0" Grid.RowSpan="3"
                                            Text="Delete"
                                            BackgroundColor="{StaticResource Error}"
                                            Command="{Binding BindingContext.DeleteConfigCommand, Source={RelativeSource AncestorType={x:Type ContentPage}}}"
                                            CommandParameter="{Binding Id}"
                                            WidthRequest="80"
                                            Margin="5,0"/>
                                </Grid>
                            </Frame>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>
            </RefreshView>

            <Button Text="Disconnect" 
                Command="{Binding DisconnectCommand}"
                IsVisible="{Binding Configs, Converter={StaticResource AnyItemConnectedConverter}}"
                HorizontalOptions="Center"/>
            
        </VerticalStackLayout>
    </ScrollView>         

</ContentPage>
